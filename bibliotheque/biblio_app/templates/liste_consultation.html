{% extends 'admin_nav.html' %}
{% load static %}
{% block content %}
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const deleteButtons = document.querySelectorAll('.delete-btn');
      const csrfToken = '{{ csrf_token }}';

      deleteButtons.forEach(button => {
        button.addEventListener('click', function () {
          const id_consultation = this.getAttribute('data-id_consultation');
          const confirmation = confirm("Êtes-vous sûr de vouloir supprimer cette consultation ?");

          if (confirmation) {
            fetch(`/supprimer_consultation/${id_consultation}/`, {
              method: 'DELETE',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
              }
            })
            .then(response => {
              if (!response.ok) {
                throw new Error('La réponse du réseau n\'était pas correcte');
              }
              return response.json();
            })
            .then(data => {
              if (data.message) {
                alert(data.message);
                location.reload();
              } else if (data.error) {
                alert(data.error);
              }
            })
            .catch(error => {
              console.error('Erreur :', error);
            });
          }
        });
      });
    });
  </script>

  <div class="container mt-5">
    <h2>Liste des Consultations</h2>

    <div class="container mt-3">
      <input type="text" id="searchOuvrage" class="form-control" placeholder="Recherche par Ouvrage ou par Exemplaire">
    </div>

    <div class="container mt-3">
      <input type="text" id="searchBibliothecaire" class="form-control" placeholder="Recherche par Adhérent ou par Utilisateur">
    </div>
    
    <div class="container mt-3">
      <button class="btn btn-primary" onclick="sortTable(6)">Trier par Date de Sortie</button>
      <button class="btn btn-primary" onclick="sortTable(7)">Trier par Date de Retour</button><br><br>
      {% if consultations.has_previous %}
      <button type="button" class="btn btn-danger mb-3" onclick="filterDeadlineSurpassed()">Délais dépassé</button>
      {% endif %}
    </div>

    <table class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Ouvrage</th>
          <th>Image</th>
          <th>ID Exemplaire</th>
          <th>ID Adhérent</th>
          <th>ID Utilisateur</th>
          <th>Date de Sortie</th>
          <th>Date de Retour</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for consultation in consultations %}
          <tr>
            <td>{{ consultation.id_consultation }}</td>
            <td>{{ consultation.ouvrage.titre }}</td>
            <td><img src="{{ consultation.ouvrage.image.url }}" style="max-width: 50%; height: auto;"></td>
            <td>{{ consultation.exemplaire.id_exemplaire }}</td>
            <td>{{ consultation.bibliothecaire_id }}</td>
            <td>{{ consultation.utilisateur.email }}</td>
            <td>{{ consultation.date_sortie }}</td>
            <td>{{ consultation.date_retour }}</td>
            <td>
              <button class="btn btn-danger delete-btn" data-id_consultation="{{ consultation.id_consultation }}">Supprimer</button>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="pagination">
      <nav aria-label="Page navigation">
        <ul class="pagination">
            {% if consultations.has_previous %}
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a></li>
            {% endif %}
            {% for num in consultations.paginator.page_range %}
            <li class="page-item {% if page_obj.number == num %}active{% endif %}"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
            {% endfor %}
            {% if consultations.has_next %}
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a></li>
            {% endif %}
        </ul>
    </nav>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <style>
    table {
      border-collapse: collapse;
      width: 100%;
    }

    th, td {
      border: 1px solid #dddddd;
      text-align: left;
      padding: 8px;
    }

    th {
      background-color: #f2f2f2;
    }

    .pagination {
      margin-top: 20px;
    }
    .deadline-surpassed {
      background-color: #f67a7a;
    }
  </style>
  <script>
    // Ajoutez ici le reste de votre JavaScript pour la pagination, le filtrage, le tri, etc.
  </script>
{% endblock content %}
